# 문제 이해 및 설계 범위 확정

- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원 클라이언트: 모바일 앱, 웹브라우저, 스마트 TV

### 개략적 규모 추정

- DAU 5백만
- 비디오 저장 = 150TB
- CDN 비용

# 개략적 설계안 제시 및 동의

- BLOB (Binary Large Object) Storage
    - 비정형 데이터 저장에 최적화(txt, 멀티미디어 파일, 로그 파일 등)
    
    3가지의 저장계층
    
    - Hot Tier: 자주 접근하는 데이터 저장
    - Cool Tier: 자주 접근하지 않지만 장기적으로 보관할 데이터 저장
    - Archive Tier: 거의 접근하지 않지만 장기적으로 보관할 데이터 저장

### 개략적 시스템

![image](https://github.com/user-attachments/assets/6d63105d-04d3-4fe7-b627-b341763d62b5)

- 단말(client)
- CDN
    - 비디오는 CDN에 저장한다. 재생 버튼을 누르면 CDN으로부터 스트리밍이 이루어진다.
- API 서버
    - 비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다.
    - 피드 추천, 비디오 업로드 URL 생성, 메타데이터 DB와 캐시 갱신, 사용자 가입

### 비디오 업로드 절차

![image](https://github.com/user-attachments/assets/86ac0e26-680e-4a44-87d3-879bf783a4f9)

- 메타데이터 데이터베이스
    - 비디오의 메타데이터 보관
    - 샤딩과 다중화 적용
- 메타데이터 캐시
    - 비디오 메타데이터와 사용자 객체(user object)는 캐시
- 트랜스코딩(비디오 인코딩)
    - 비디오의 포맷(MPEG)을 변환하는 절차다.
    - 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림을 제공하기 위해 필요하다.
- 트랜스코딩 비디오 저장소(transcoded storage)
    - 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소
- CDN
    - 비디오를 캐시
- 트랜스코딩 완료 큐(completion queue)
    - 비디오 트랜스코딩 완료 이벤트들을 보관할 메시지 큐
    
    <aside>
    💡 트랜스코딩 작업은 시간이 많이 걸림. 트랜스코딩 서버는 작업을 비동기적으로 처리.
    
    </aside>
    
- 트랜스코딩 완료 핸들러(completion handler)
    - completion queue에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 DB를 갱신할 작업 서버들

<aside>
💡 다음 두 프로세스가 병렬 수행
a. 비디오 업로드
b. 비디오 메타데이터 갱신

</aside>

### 프로세스 a: 비디오 업로드

1. 비디오를 원본 저장소에 업로드
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩 수행
    - 트랜스코딩은 동영상을 다양한 포맷과 해상도로 변환하는 과정을 말함
3. 트랜스코딩 완료 (아래 두 절차는 병렬적으로 처리 된다)
    1. **완료된 비디오 → 트랜스코딩 비디오 저장소로 업로드**
    2. **트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣음**
        1. 트랜스코딩 끝난 비디오를 CDN에 올린다
        2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다
        3. 완료 핸들러가 메타데이터 DB와 캐시를 갱신한다.
        - `메타데이터(트랜스코딩 정보, 가용 해상도)`

### 프로세스b: 메타데이터 갱신

- 원본 저장소에 파일이 업로드되는 동안, **단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버**에 보냄
    - `메타데이터(비디오 제목, 설명, 태그, 카테고리)`

## 비디오 스트리밍 절차

- 스트리밍은 단말이 원격지의 비디오로부터 지속적으로 비디오 스트림을 전송 받아 영상을 재생하는 것
- 비디오는 CDN에서 바로 스트리밍된다.
- 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당한다.

# 상세 설계

### 비디오 트랜스코딩

- 비디오가 다른 단말에서도 재생되려면 호환되는 비트레이트(bitrate)와 포맷으로 저장되어야 한다.

비디오 트랜스코딩이 중요한 이유

- raw video는 저장 공간을 많이 차지한다.
- 상당수의 단말과 브라우저는 특정 종류의 비디오 포맷만 지원한다.
    - 따라서 하나의 비디오를 여러 포맷으로 인코딩해 두는 것이 바람직하다.

인코딩 포멧

- 컨테이너(container)
    - 비디오 파일, 오디오, 메타데이터를 담는 바구니 같은 것
- 코덱(codec)
    - 화질은 보존하면서 파일 크기를 줄일 목적으로 고안된 압축 및 압축 해제 알고리즘

### 유향 비순환 그래프(DAG) 모델

- 컨텐츠 창작자는 각자 자기만의 비디오 프로세싱 요구사항을 갖고 있음
- 각기 다른 유형의 비디오 프로세싱 파이프라인을 지원하는 한편 처리 과정의 병렬성을 높이기 위해서는 적절한 수준의 추상화를 도입하여 클라이언트 프로그래머로 하여금 실행할 작업을 손수 정의할 수 있도록 해야 한다.
    
    ![image](https://github.com/user-attachments/assets/80feea0c-217c-42f9-8101-a995e4322616)
    

### 비디오 트랜스코딩 아키텍처

![image](https://github.com/user-attachments/assets/d5388daa-0f79-46c7-81a5-799238b7d347)

- 전처리기 (다음 3가지 일을 한다)
    - 비디오 분할
        - 비디오 스트림을 GOP(Group of Pictures)라 불리는 단위로 쪼갠다.
            - GOP는 특정 순서로 배열된 프레임(frame) 그룹
            - 하나의 GOP는 재생 가능하며, 보통 몇 초 정도
    - DAG 생성
        - 클라이언트 프로그래머가 작성한 설정 파일에 따라 DAG를 만들어낸다.
    - 데이터 캐시
        - 전처리기는 분할된 비디오의 캐시이기도 하다.
        - GOP와 메타데이터를 임시 저장소에 보관

- DAG 스케줄러
    - 비디오, 오디오 인코딩 및 메타데이터 추출

- 자원 관리자
    
    ![image](https://github.com/user-attachments/assets/d1c822b8-10ec-418b-8804-2e3f409a6587)
    
    - 적절한 작업, 적절한 작업 서버를 골라서 작업함

### 속도 최적화

- 비디오 병렬 업로드
    - 하나의 비디오를 작은 GOP들로 분할하여 병렬적으로 업로드한다.

- 모든 절차를 병렬화 (메시지 큐 도입으로 느슨하게)
    - 메시지 큐에 보관된 이벤트 각각을 이벤트 모듈은 병렬적으로 처리할 수 있다.

![image](https://github.com/user-attachments/assets/77c27f5a-0cd3-4d8c-a7f4-2ca6ca61fbe0)

- 업로드 최적화: presignedURL
    - authorized 사용자만이 비디오 업로드를 할 수 있도록 하기 위해 pre-signed upload URL을 이용한다.
    - 사용자는 서버를 거치지 않고 직접 클라우드 스토리지로 파일을 업로드할 수 있으므로 업로드 속도가 빨라짐

- 안전성 최적화: 비디오 보호
    - 비디오 저작권 보고하기 위해, 다음 세 가지 선택지 가운데 하나를 채택할 수 있음
    - 디지털 저작권 관리(DRM) 시스템 도입

- 비용 최적화
    - CDN은 비싸다.
        - 대부분 비디오 스트리밍은 롱테일(long-tail) 분포를 따른다.
        - 인기 있는 비디오는 빈번히, 나머지는 거의 보는 사람이 없다.
    - 인기 비디오는 CDN을 통해 재생하되, 다른 비디오는 비디오 서버를 통해 재생
    - CDN을 직접 구축하고 ISP와 제휴?

### 오류 처리

시스템 오류에는 두 가지 종류가 있다.

- recoverable error
    - 특정 비디오 세그먼트를 트랜스코딩하다 실패했다든가 하는 오류
- non-recoverable error
    - 비디오 포맷이 잘못됨