# 11장. 뉴스 피드 시스템 설계

- **뉴스 피드**
    - 지속적으로 업데이트 되는 스토리들

## 1단계. 문제 이해 및 설계 범위 확정

- **요구 사항**
    - 뉴스 피드 페이지에 새로운 스토리 등록, 다른 친구가 올리는 스토리 볼 수 있음
    - 스토리 정렬 순서 (시간순, 토픽 점수, …)
    - 최대 5000명의 친구
    - 매일 천만 명 방문
    - 이미지, 비디오 등의 미디어 파일 포함

## 2단계. 개략적 설계안 제시 및 동의 구하기

- 피드 발행
    - 사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 DB에 기록.
    - 새 포스팅은 친구의 뉴스 피드에도 전송.
- 뉴스 피드 생성
    - 뉴스 피드는 모든 친구의 포스팅을 시간 흐름 역순으로 모아서 만든다.

- **뉴스 피드 API**
    - 뉴스 피드 API는 클라이언트가 서버와 통신하기 위해 사용하는 수단
    - HTTP 프로토콜 기반
    - 상태 정보 업데이트, 뉴스 피드 가져오기, 친구 추가, …

- **피드 발행 API**
    - HTTP POST 요청
        
        ```xml
        POST /v1/me/feed
        ```
        
        - 인자
            - body: 포스팅 내용
            - Authorization 헤더: API 호출 인증

- **피드 읽기 API**
    - 뉴스 피드 가져오기
        
        ```xml
        GET /v1/me/feed
        ```
        
        - 인자
            - Authorization 헤더: API 호출 인증
        
- **피드 발행**
    
    ![Untitled](11%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%82%E1%85%B2%E1%84%89%E1%85%B3%20%E1%84%91%E1%85%B5%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%207c572b35fa834b25b6efeb89db49e04b/Untitled.png)
    
    - 로드밸런서: 트래픽을 웹 서버들로 분산
    - 웹 서버 : HTTP 요청을 내부 서비스로 중계하는 역할
    - 포스팅 저장 서비스: 새 포스팅을 DB와 캐시에 저장
    - 포스팅 전송 서비스: 뉴스 피드 푸시, 뉴스 피드 캐시에 보관하여 빠르게 읽음
    - 알림 서비스: 새 포스팅이 올라왔음을 알림

- **뉴스 피드 생성**
    
    ![Untitled](11%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%82%E1%85%B2%E1%84%89%E1%85%B3%20%E1%84%91%E1%85%B5%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%207c572b35fa834b25b6efeb89db49e04b/Untitled%201.png)
    
    - 로드 밸런서: 트래픽을 웹 서버들로 분산
    - 뉴스 피드 서비스: 캐시에서 뉴스 피드를 가져오는 서비스
    - 뉴스 피드 캐시: 뉴스 피드를 렌더링할 때 필요한 피드 ID 보관

## 3단계. 상세 설계

- **피드 발행 흐름 상세 설계**
    - **웹 서버**
        - 클라이언트와 통신 뿐 아니라, 인증이나 처리율 제한 등의 기능도 수행
        - 올바른 인증 토큰을 Authorization 헤더에 넣고 API 호출 (인증 처리)
        - 한 사람이 과도한 포스팅을 올리지 못하도록 처리율 제한 기능도 수행
        
    - **포스팅 전송(팬아웃) 서비스**
        - 포스팅 전송(팬아웃)은 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 역할
        - 팬아웃
            - 분산 시스템에서 중요한 패턴 중 하나
            - 하나의 메시지나 이벤트를 여러 수신자에게 동시에 전달하는 데 사용
    
    - **쓰기 시점에서 팬 아웃(push)**
        - 포스팅이 완료되면 바로 해당 사용자의 캐시에 기록
        - 장점
            - 실시간 갱신 (친구 목록에 있는 사용자에게 즉시 전송)
            - 뉴스 피드를 읽는 시점에는 이미 업데이트 되어 있음
        - 단점
            - 친구가 많은 사용자(**핫키**)는 뉴스 피드 갱신에 오랜 시간이 걸림
            - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원 낭비
    
    - **읽기 시점에서 팬 아웃(pull)**
        - 피드를 읽어야하는 시점에서 새로운 뉴스 피드 갱신
        - 장점
            - 서비스를 자주 사용하지 않는 경우에 유리
            - 데이터를 친구 각각에 푸시하는 작업이 없어 핫키 문제 해결
        - 단점
            - 뉴스 피드를 읽는데 많은 시간이 소요

- 기본적으로 푸시 모델을 사용
- 친구가 많은 사용자(핫키), 자주 사용하지 않는 경우 풀 모델을 사용
- 요청과 데이터를 보다 고르게 분산하여 핫키 문제 해결 ← 안정 해시

![Untitled](11%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%82%E1%85%B2%E1%84%89%E1%85%B3%20%E1%84%91%E1%85%B5%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%207c572b35fa834b25b6efeb89db49e04b/Untitled%202.png)

- **동작 과정**
    - **팬 아웃 서비스 (쓰기)**
        - 그래프 DB에서 친구 ID 목록을 가져온다.
        - 사용자 정보 캐시에서 친구들의 정보를 가져온다.
            - 사용자 설정에 따라 친구 필터링 (업데이트 무시, 보이지 않게 설정, …)
        - 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣음
        - 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내어 뉴스 피드 데이터를 뉴스 피드 캐시에 넣는다.
            - 뉴스 피드 캐시 : <포스팅 ID, 사용자 ID>
    
- **피드 읽기 흐름 상세 설계**
    - 이미지나 미디어 데이터는 CDN을 사용해 빠르게 읽기

- **동작 과정**
    - 사용자가 뉴스 피드를 읽으려는 요청을 보냄
        - 요청 : /v1/me/feed
    - 로드밸런서가 요청을 웹 서버 가운데 하나로 보냄
    - 웹 서버는 피드를 가져오기 위해 뉴스 피드 서비스를 호출
    - 뉴스 피드 서비스는 뉴스 피드 캐시에서 포스팅 ID 목록을 가져옴
    - 뉴스 피드에 표시할 사용자 이름, 사용자 사진, 포스팅 콘텐츠, 이미지 등을 사용자 캐시와 포스팅 캐시에서 가져와 완전한 뉴스 피드를 만듦
    - 생성된 뉴스 피드 JSON 전달 → 클라이언트 렌더링

- **캐시 구조**
    
    ![Untitled](11%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%82%E1%85%B2%E1%84%89%E1%85%B3%20%E1%84%91%E1%85%B5%E1%84%83%E1%85%B3%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%207c572b35fa834b25b6efeb89db49e04b/Untitled%203.png)
    
    - **뉴스 피드**
        - 뉴스 피드의 ID를 보관
    - **콘텐츠**
        - 포스팅 데이터를 보관
        - 인기 콘텐츠는 따로 보관
    - **소셜 그래프**
        - 사용자 간 관계 정보를 보관
    - **행동**
        - 포스팅에 대한 사용자 행위에 관한 정보를 보관
        - 좋아요, 답글, …
    - **횟수(counter)**
        - 좋아요 횟수, 응답 수, 팔로어 수, 팔로잉 수 등의 정보를 보관
    

## 4단계. 마무리

**데이터 베이스 규모 확장**

- 수직적 규모 확장 vs 수평적 규모 확장
- SQL vs NoSQL
- (master-slave) 다중화
- 복제본(replica)에 대한 읽기 연산
- 일관성 모델(consistency model)
- DB 샤딩 (sharding)

**이 외에도 논의해 보면 좋을 만한 주제**

- 웹 계층(web tier)을 무상태로 운영하기
- 가능한 한 많은 데이터를 캐시할 방법
- 여러 데이터 센터를 지원할 방법
- 메시지 큐를 사용하여 컴포넌트 사이의 결합도 낮추기
- 핵심 메트릭(key metric)에 대한 모니터 링.
    - 트래픽이 몰리는 시간대의 QPS(Queries per Second)
    - 사용자가 뉴스 피드를 새로고침(refresh) 할때의 지연시간 등이 이에 해당한다.

## !Tip

### 그래프 DB가 친구 관계나 친구 추천을 관리하기 적합한 이유

- **관계 중심 모델링**
    - 그래프 DB는 노드와 엣지를 사용해 데이터 간의 관계를 직접적으로 표현합니다. 이는 사람(노드)과 친구 관계(엣지)를 자연스럽게 모델링하는 데 이상적입니다.
- **연결 패턴 탐색 용이**
    - 그래프 탐색 알고리즘을 사용해 복잡한 관계 패턴(예: 친구의 친구)을 쉽게 찾을 수 있습니다.
- **성능 최적화**
    - 관계 기반 쿼리에 최적화되어 있어, 대규모 소셜 네트워크에서도 빠른 처리가 가능합니다.
- **유연한 스키마**
    - 새로운 관계 유형을 쉽게 추가할 수 있어, 소셜 네트워크의 진화에 따라 유연하게 대응할 수 있습니다.
- **추천 알고리즘 지원**
    - 그래프 구조는 공통 친구, 관심사 기반 추천 등 다양한 추천 알고리즘 구현에 적합합니다.
    

레디스 펍섭

sqs