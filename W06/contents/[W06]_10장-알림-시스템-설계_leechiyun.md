# 10장. 알림 시스템 설계

- **알림 시스템**
    - 애플리케이션 프로그램에서 최신 뉴스, 제품 업데이트, 이벤트, 선물 등 **고객에게 중요할 만한 정보를 비동기적으로 제공**
    - 모바일 푸시 알림, SMS 메시지, 이메일

## 1단계. 문제 이해 및 설계 범위 확정

- 하루에 백만건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는건 어렵다.
- 면접관과 질문을 통해, 요구 사항 정리 (정해진 답은 없다.)

- **요구 사항**
    - 푸시 알림, SMS 메시지, 이메일 제공
    - 실시간 시스템, 하지만 시스템 부하로 인한 지연 허용
    - ios 단말, 안드로이드 단말, 랩톱/데스크톱 지원
    - 클라이언트에서 프로그램 or 서버 스케줄링
    - 알림을 받지 않는 설정 가능
    - 1천만 건의 모바일 푸시 알림, 1백만 건의 SMS 메시지, 5백만 건의 이메일

## 2단계. 개략적 설계안 제시 및 동의 구하기

- **알림 유형별 지원 방안**
    - **iOS 푸시 알림**
        - 알림 제공자 → APNS(애플 푸시 알림 서비스) → ios 단말(핸드폰)
        - **알림 제공자**
            - 알림 요청(req)을 만들어, 애플 푸시 알림 서비스(APNS)로 보내는 주체
            - **단말 토큰**
                - 알림 요청을 보내는데 필요한 **고유 식별자(id)**
            - **페이로드**
                - 알림 내용을 담은 JSON 딕셔너리(사전)
                
                ```json
                {
                	"aps": {
                		"alert" {
                			"title": "Game Request",
                			"body": "Bob wants to play chess",
                			"action-loc-key": "PLAY"
                		}
                		"badge": 5
                	}
                }
                ```
                
        - APNS
            - 푸시 알림을 ios 단말로 보내는 역할
        - ios 단말
            - 푸시 알림을 수신

- **안드로이드 푸시 알림**
    - APNS 대신, FCM

- **SMS 메시지**
    - 트윌리오, 넥스모 (제3 사업자 서비스) → 비용 O

- **이메일**
    - 고유 이메일 서비스도 구축 가능
    - 상용 이메일 : 센드그리드, 메일침프
        - 전송 성공률 높고, 데이터 분석 제공
        

**※ 식별, 비식별**

- 식별
    - 부모 테이블의 기본키 또는 유니크 키를 자식 테이블이 자신의 기본키로 사용
- 비식별
    - 부모 테이블의 기본키 또는 유니크 키를 자신의 기본키로 사용하지 않고, **외래 키로 사용**하는 관계

- **연락처 정보 수집 절차**
    - 알림 재료
        - 모바일 단말 토큰, 전화 번호, 이메일 주소, …
        - 연락처 정보 DB 저장
            
            ![Untitled](10%E1%84%8C%E1%85%A1%E1%86%BC%20%E1%84%8B%E1%85%A1%E1%86%AF%E1%84%85%E1%85%B5%E1%86%B7%20%E1%84%89%E1%85%B5%E1%84%89%E1%85%B3%E1%84%90%E1%85%A6%E1%86%B7%20%E1%84%89%E1%85%A5%E1%86%AF%E1%84%80%E1%85%A8%2072ac0ff5536448eb9d2acbcafd31825b/Untitled.png)
            

- **알림 전송 및 수신 절차**
    - **개략적 설계안 (초안)**
        - **1~N가지 서비스**
            - 과금 서비스 알림,…과 같은 **여러 알림 서비스 종류**
        - **알림 시스템**
            - 1개의 알림 시스템 서버로 가정하면 1~N 개의 알림 서비스 API 제공, 제3자에게 전달할 알림 페이로드(데이터)를 생성
            - 각각의 단말에 맞는 알림 제공 서비스에 전달
        - **확장성**
            - 새로운 서비스 통합 및 기존 서비스 제거가 용이
            - 어떤 서비스는 지역에 따라 금지
    
    - **문제점**
        - **SPOF (단일 실패 지점)**
            - 알림 서비스에 서버가 하나밖에 없으면, 서버 하나의 정리로 모든 서비스 정지(가용성 낮음)
        - **규모 확장성**
            - 한 대의 서비스로 푸시 알림에 관한 모든 것을 처리
            - DB나 캐시 등 중요 컴포넌트의 규모를 개별적(단말에 따라)으로 늘리기 어려움
        - **성능 병목**
            - 트래픽이 많이 몰리면 시스템 과부하
    
    - **개략적 설계안 (개선)**
        - DB와 캐시 시스템 분리
        - 알림 서버 자동 증설, 수평적 규모 확장
        - 메시지 큐를 이용 → 컴포넌트간 강한 결합 끊기 (성능 병목 줄임)
    
    - **알림 서버**
        - 알림 전송 API
            - 스팸 방지를 위해 보통 사내 서비스 또는 인증된 클라이언트만 이용 가능
        - 알림 검증
            - 이메일 주소, 전화 번호 등에 대한 기본 검증
        - DB 또는 캐시 질의
            - 알림에 포함시킬 데이터를 가져오는 기능
        - 알림 전송
            - 알림 데이터를 메시지 큐 전송 (병렬적 처리)
    
    - **전체적인 동작 과정**
        - API를 호출하여, 알림 서버로 알림을 보냄
        - 알림 서버는 사용자 정보, 단말 토큰, 알림 설정 같은 메타데이터(metadata)를 캐시나 DB에서 가져옴
        - 알림 서버는 전송할 알림에 맞는 이벤트를 만들어, 해당 이벤트에 맞는 메시지 큐에 푸시
        - 작업 서버는 메시지 큐에서 알림 이벤트를 꺼냄
        - 작업 서버는 알림을 제3자 서비스로 보냄
        - 제3자 서비스는 단말로 알림 전송
    
    ### ! Tip
    
    - 버퍼
        - 버퍼는 데이터를 일시적으로 저장하는 메모리 영역을 의미합니다. 이는 데이터 처리 속도의 차이를 조절하거나 데이터를 임시로 보관하는 용도로 사용됩니다.
    
    1. 속도 차이 해소
        - 빠른 장치와 느린 장치 사이의 속도 차이를 완화합니다.
        - 예: CPU와 하드 디스크 간 데이터 전송 시 사용
    2. 데이터 일시 저장
        - 처리 대기 중인 데이터를 임시로 보관합니다.
        - 예: 네트워크 패킷 수신 시 처리 전 저장
    3. 효율성 향상
        - 작은 단위의 데이터 처리 대신 큰 블록 단위로 처리하여 효율을 높입니다.
    4. 데이터 정렬
        - 입력 순서와 출력 순서가 다를 때 데이터를 재정렬합니다.
    5. 오류 방지
        - 데이터 흐름의 일시적 중단이나 지연 시 안정성을 제공합니다.
    6. 멀티태스킹 지원
        - 여러 프로세스나 스레드 간 데이터 공유를 가능하게 합니다.
    

## 3단계. 상세 설계

- **안전성**
    - **데이터 손실 방지**
        - 알림이 손실 되어서는 안된다!!
        - 순서나 지연은 허용
    
    - **알림 로그 DB**
        - 로그로 확인하여 **재시도 알고리즘** 활용
    
    - **알림 중복 전송 방지**
        - 중복 탐지 매커니즘
            - 이벤트 id를 검사하여, 중복된 이벤트라면 버리고 그렇지 않으면 발송

- **추가 필요 컴포넌트**
    - 알림 템플릿, 알림 설정, 이벤트 추적, 시스템 모니터링, 처리율 제한, …

- **알림 템플릿**
    - 알림 메시지 대부분 형식이 비슷
    - parameter, 스타일, 추적 링크를 조정하기만 하면 사전에 지정된 형식에 맞춰 알람을 만듦
        
        ```json
        여러분~! [item_name]이 드디어 출시했습니다! [date]까지만 입고~~
        ```
        
- **알림 설정**
    
    ```json
    user_id    big int
    channel    varchar    # 알림이 전송될 채널. 푸시 알림, 이메일, SMS 등
    opt_in     boolean    # 해당 태널로 알림을 받을 것인지의 여부
    ```
    
- **전송률 제한**
    - 한 사용자가 받을 수 있는 알림 빈도 제한

- **푸시 알림과 보안**
    - 알림 전송 API를 appKey와 appSecret을 사용하여 보안을 유지
    - 인증된(authenticated), 승인된(verified) 클라이언트만 해당 API를 통해 알림 전송 가능

- **큐 모니터링**
    - 메시지 큐에 쌓인 알림 메트릭
        - 해당 메트릭에 따라 작업 서버 증설, 삭제

- **이벤트 추적**
    - 데이터 분석 서비스

## 4단계. 마무리

- 쿠폰, 출시 정보, 신규 상품, 상품 추천 모두 알림을 통해 기능 제공
- **메시지 큐**를 사용하여 컴포넌트 사이의 결합도를 낮추자!

- 안전성
    - 메시지 전송 실패율을 낮추기 위해 안정적인 재시도 메커니즘 도입
- 보안
    - 인증된 클라이언트만이 알림을 보낼 수 있도록 appKey, appSecret 등의 매커니즘 이용
- 이벤트 추적 및 모니터링
    - 알림이 만들어진 후, 성공적으로 전송되기까지의 과정을 추적
    - 모니터링을 통해 유연한 설계 가능
- 사용자 설정
    - 알림 수신 설정
- 전송률 제한
    - 사용자에게 알림을 보내는 빈도를 제한 가능