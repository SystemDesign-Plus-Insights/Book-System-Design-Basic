# 1) 문제 이해 및  설계 범위 확정

- 앱/웹 지원
- 사용자는 뉴스 피드 페이지에 새로운 스토리를 올릴 수 있어야 하고, 친구들이 올리는 스토리를 볼 수도 있어야 한다.
- 스토리 순서는 시간 흐름 역순으로 표시
- 5000명의 친구
- DAU 천만명
- 스토리에는 이미지, 비디오 등의 미디어 파일 포함

# 2) 개략적 설계안 제시 및 동의 구하기

## 뉴스 피드 API

### 피드 발행 API

- 새 스토리를 포스팅하기 위한 API

![image](https://github.com/SystemDesign-Plus-Insights/Book-System-Design-Basic/assets/62508156/5edbf904-9ed5-409e-8e7e-5804b0629230)

- 포스팅 저장 서비스: 새 포스팅을 DB와 캐시에 저장
    - 포스팅 조회는 피드 캐시에서 이루어지는데, 포스팅 캐시는 왜 두는거지? 단지 역할 분담인건가
- 포스팅 전송 서비스: 새 포스팅을 친구의 뉴스 피드에 푸시한다. 뉴스 피드 데이터는 캐시에 보관하여 빠르게 읽어갈 수 있도록 한다.

### 뉴스 피드 생성

![image](https://github.com/SystemDesign-Plus-Insights/Book-System-Design-Basic/assets/62508156/c71caba5-26f1-48f1-b2df-30c27a74b64c)

- 뉴스 피드 캐시: 뉴스 피드를 렌더링할 때 필요한 피드 ID를 보관한다.

# 3) 상세 설계

### 웹 서버

- 인증, 처리율 제한, validation(한 사용자가 올릴 수 있는 포스팅 수 제한)

### 포스팅 전송(팬아웃) 서비스

- 어떤 사용자의 새 포스팅을 그 사용자와 친구 관계에 있는 모든 사용자에게 전달하는 과정이다.

![image](https://github.com/SystemDesign-Plus-Insights/Book-System-Design-Basic/assets/62508156/2df2c767-9b28-462b-a330-c4a724265eb9)

- 쓰기 시점에 팬아웃(push 모델): 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신
    - 장점
        - 뉴스 피드가 실시간 갱신
        - 뉴스 피드를 읽는 데 드는 시간이 짧음
    - 단점
        - 친구가 많은 경우, 친구 목록 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요될 수 있음(핫키 문제)
        - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅 자원이 낭비됨

- 읽기 시점에 팬아웃(pull 모델): 피드를 읽는 시점에 뉴스 피드 갱신 (온디맨드 모델)
    - 장점
        - 비활성화, 자주 이용하지 않는 사용자의 경우 이 모델이 유리함. 로그인까지 어떤 자원도 소모되지 않음
        - 핫키 문제 해결
    - 단점
        - 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있음

<aside>
💡 대부분의 사용자에 대해서는 푸시 모델을 사용하되, 친구가 아주 많은 사용자의 경우 팔로워로 하여금 풀 모델을 사용하도록 함.

안정 해시를 통해 요청과 데이터를 고르게 분산하여 핫키 문제를 줄임.

</aside>

![image](https://github.com/SystemDesign-Plus-Insights/Book-System-Design-Basic/assets/62508156/83244b1f-d162-4237-8b7b-389804a0fc12)

1. 그래프 DB에서 친구 ID 목록을 가져온다. (그래프 DB는 친구 관계, 친구 추천을 관리하기 적합하다)
2. 사용자 정보 캐시에서 친구들의 정보를 가져온다. 
3. 친구 목록과 새 스토리의 포스팅 ID를 메시지 큐에 넣는다.
4. 팬아웃 작업 서버가 메시지 큐에서 데이터를 꺼내서 뉴스 피드 캐시에 넣는다.
    - 뉴스 피드 캐시는 <포스팅ID, 사용자ID>의 순서쌍을 보관하는 매핑 테이블이라 볼 수 있다.
    - ID만 보관하는 이유는 메모리 요구량이 지나치게 늘어날 수 있기 때문이다.
    - 대부분의 사용자가 보려하는 것은 최신 스토리다. 따라서 캐시 미스가 일어날 확률은 적다.

### 피드 읽기 흐름 상세 설계

![image](https://github.com/SystemDesign-Plus-Insights/Book-System-Design-Basic/assets/62508156/388c903f-6b36-4bc7-b4fe-5f600613b9a9)

유명인의 경우 풀푸시 모델을 사용. 그럼 피드 조회 시,  푸시 모델로 미리 캐시된 포스팅과 풀 모델로 실시간으로 데이터베이스에서 집계된 포스팅이 결합되어 동적으로 피드를 구성