# 7장. 분산 시스템을 위한 유일 ID 생성기 설계

- 서버 한 대로는 DB에서 auto_increment 속성을 사용해도 가능
- 분산 환경에서는 auto_increment로 유일성을 얻기 어렵다
    - 동기화 및 유일성 문제

## 1단계. 문제 이해 및 설계 범위 확정

- 문제 이해와 설계 범위는 면접관과 대화하며 정한다.

- **요구사항**
    - ID는 유일
    - ID는 숫자로만 구성
    - ID는 64비트로 표현 가능
    - ID는 발급 날짜에 따라 정렬 가능
    - 초당 10,000개의 ID를 만들 수 있다.

## 2단계. 개략적 설계안 제시 및 동의 구하기

### 다중 마스터 복제

- auto_increment 값을 서버마다 (1≤k≤N) k만큼 올린다.
- 문제점
    - 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다
    - ID 유일성은 보장되지만, 시간에 따라 커지도록 구현하기 어려움 (발급 날짜 정렬 불가능)
    - 서버를 추가하거나 삭제할 때 대응 어려움

### UUID

- 컴퓨터 시스템에 저장되는 정보를 유일하게 식별하기 위한 128비트 수
    - 09c93e62-50b4-468d-bf8a-c07e1040bfb2
- UUID는 충돌(유일성 깨짐) 문제가 거의 발생하지 않는다.
- 각 서버마다 독립적인 ID 생성기를 활용해 ID 생성 가능
- 장점
    - UUID를 만드는 것은 단순
    - 서버 사이의 동기화 필요 X
    - 서버에 ID 생성기를 각자 사용하므로 확장이 쉽다
- 단점
    - ID가 128bit로 길다. (64bit X)
    - ID를 시간순으로 정렬 불가능
    - ID에 숫자가 아닌 값이 들어감

### 티켓 서버

- 티켓 서버라는 중앙 집중형 DB 서버를 구현하고 auto_increment 사용
- 장점
    - 유일성이 보장되는 오직 숫자로만 구성된 ID 쉽게 생성 가능
    - 구현이 쉽고, 작은 규모의 애플리케이션에 적합
- 단점
    - 해당 티켓 서버가 단일 실패 지점(SPOF)가 된다.
    - 해당 문제를 피하기 위해선 여러 대의 티켓 서버가 필요하지만, 동기화 문제가 발생

### 트위터 스노플레이크 접근법

- 분할 정복 알고리즘 활용
- ID의 구조를 여러 Section으로 분할
    - 사인(sign) 비트: 1bit
        - 음수와 양수를 구분하는데 사용 가능
    - 타임스탬프: 41bit
        - 기원 시각 이후 얼마나 경과했는지 파악(트위터 스노플레이크 구현)
    - 데이터센터 ID: 5bit
        - 2^5 = 32개의 데이터센터 지원 가능
    - 서버 ID: 5bit
        - 32개의 데이터 센터당 32개의 서버 지원 가능
    - 일련번호: 12bit
        - 일련번호를 ID 생성시마다 1씩 증가, 1밀리초가 지나면 0으로 초기화

## 3단계. 상세 설계

- 데이터센터ID, 서버ID는 시스템 시작 전에 설계 → 시스템 운영 중에는 바꾸지 않는다.
- **타임스탬프**
    - 시간의 흐름에 따라 큰 값을 가짐 (정렬 가능)

## 4단계. 마무리

- **시계 동기화**
    - 타임스탬프 설정 시, 같은 시계열을 사용한다고 가정
    - NTP (해결법)
- **각 section 길이 최적화**
    - 동시성이 낮고 수명이 긴 애플리케이션의 경우 일련번호를 줄이고 타임스탬프를 늘리는게 좋다.

## Tip

- **"동시성이 낮다"**
    1. 단위 시간당 ID 생성 요청이 적다는 뜻입니다. 즉, 시스템이 짧은 시간 내에 많은 고유 ID를 생성할 필요가 없습니다.
    2. 동시에 여러 ID를 생성해야 하는 경우가 드물다는 의미입니다.
    3. ID 충돌 가능성이 낮다는 것을 의미합니다. 여러 프로세스나 스레드가 동시에 ID를 생성할 때 같은 값을 만들 가능성이 적습니다.
    4. 시스템의 부하가 상대적으로 낮다는 것을 암시합니다. ID 생성이 시스템 리소스에 큰 부담을 주지 않습니다.

- **NTP**
    - Network Time Protocol의 약자로, 컴퓨터 시스템 간의 시간 동기화를 위한 네트워크 프로토콜
    - **목적**
        - 네트워크로 연결된 컴퓨터들의 시간을 동기화하여 정확하고 일관된 시간을 유지합니다.
    - **작동 방식**
        - 클라이언트-서버 모델을 사용합니다.
        - NTP 서버에서 정확한 시간 정보를 받아 로컬 시스템 시간을 조정합니다.
    - **정확도**
        - 밀리초 단위의 정확도를 제공할 수 있습니다.
    - **계층 구조**
        - Stratum 0부터 시작하는 계층 구조를 가집니다.
        - Stratum 0은 가장 정확한 시간원(예: 원자시계)을 나타냅니다.
    - **용도**
        - 분산 시스템의 로그 동기화
        - 금융 거래의 시간 기록
        - 네트워크 보안 프로토콜의 시간 기반 인증
    - **프로토콜**
        - 주로 UDP를 사용하며, 기본 포트는 123번입니다.
    - **보안**
        - NTP의 보안 강화 버전인 NTPsec도 있습니다.