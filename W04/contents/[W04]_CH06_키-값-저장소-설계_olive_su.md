### 키-값 저장소 설계

- key-value 저장소는 noSql중 하나
- 저장되는 값은 고유 식별자를 키로 가져야 한다.
- 키와 값 사이 연결 관계 : 키-값 쌍(pair)
- 키-값 쌍에서의 키는 유일해야 하며 해당 키에 매달린 값은 키를 통해서만 접근 가능
- 키는 텍스트일 수도, 해시 값일수도 있다.
- 당연히 키는 짧을수록 좋음
- 값은 무엇이 오든 크게 상관 없음

### 키-값 저장소 설계

#### 문제 이해 및 설계 범위 확정

- 완벽한 설계는 없다.
- 읽기, 쓰기 그리고 메모리 사용량 사이에 어떤 균형을 찾고, 데이터의 일관성과 가용성 사이에서 - 타협적 결정을 내린 설계를 만들었다면 쓸만한 답안일 것이다.

다음 특성을 갖는 키-값 저장소를 설계해 보자.

<br>

- 키-값 쌍의 크기는 10KB이하이다.
- 큰 데이터를 저장할 수 있어야 한다.
- 높은 가용성을 제공해야 한다. 따라서 시스템은 설사 장애가 있더라도 빨리 응답해야 한다.
- 높은 규모 확장성을 제공해야 한다. 따라서 트래픽 양에 따라 자동적으로 서버 증설/삭제가 이루어져야 한다.
- 데이터 일관성 수준은 조정이 가능해야 한다.
- 응답 지연시간이 짧아야 한다.

- 단일 서버 키-값 저장소
- 한대 서버만 사용하는 키-값 저장소 설계는 쉽다.
- 가장 직관적인 방법은 키-값 쌍 전부를 메모리에 해시 테이블로 저장하는 것이다.
- 다만 이는 빠른 속도를 보장하기는 하지만 모든 데이터를 메모리 안에 두는 것이 불가능할 수도 있다는 약점을 갖고 있다.

해결책은 이와 같다.

<br>

- 데이터 압축

  - 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장
  - 물론 이렇게 해도 한대로는 부족
  - 따라서 분산 키-값 저장소를 만들 필요성이 있다.

- 분산 키-값 저장소
- 분산 해시 테이블이라고도 불리는데, 이는 키-값 쌍을 여러 서버에 분산시키기 때문
- 이를 설계하기 위해서는 CAP(Consistency, Availability, Partition Tolerance Theorem)정리를 이해하고 있어야 한다.

- CAP정리
  : 데이터 일관성, 가용성, 파티션 감내 라는 세 가지 요구사항을 동시에 만족하는 분산 시스템을 설계하는 것은 불가능하다는 정리이다.

<br>

- 데이터 일관성(C)
  분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐와 관계 없이 언제나 같은 데이터를 보게 되어야 한다.

- 가용성(A)
  분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.

- 파티션 감내(P)
  파티션은 두 노드 사이에 통신 장애가 발생하였음을 의미한다.
  즉, 파티션 감내는 네트워크에 파티션이 생기더라도 시스템이 계속 동작해야 한다는 것을 뜻한다.

<br>

여기서 2가지를 충족하려면, 나머지 하나는 반드시 희생되어야 한다.

<r>

위의 세 요구사항 중 어떤 두 가지를 만족하냐에 따라 다음과 같이 분류할 수 있다.

- CP시스템
- AP시스템
- CA시스템

<br>

- 다만 통상 네트워크 장애는 피할 수 없는 것으로 여겨지기 때문에 분산시스템은 반드시 파티션 문제를 감내할 수 있도록 설계되어야 한다.
- 따라서 CA시스템은 실질 존재하지 않는다.
- 이에 관한 몇 가지 사례를 살펴본다.
- 분산 시스템에서 데이터는 보통 여러 노드에 복제되어 보관된다.

<br>

- 세 개의 복제 노드 n1, n2, n3에 데이터를 복제하여 보관하는 상황이 있다고 한다.

- 이상적 환경이라면 네트워크가 파티션되는 상황은 절대로 일어나지 않을 것이다.
- n1에 기록된 데이터는 자동적으로 n2, n3에 복제된다.
- 이는 데이터 일관성과 가용성도 만족한다.

<br>

- 분산 시스템은 파티션 문제를 피할 수 없다.
- 그리고 파티션 문제가 발생하면 우리는 일관성과 가용성 사이에서 하나를 선택하여야 한다.
