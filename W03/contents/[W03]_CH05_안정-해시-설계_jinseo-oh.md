# 해시 키 재배치(rehash) 문제

N개의 캐시 서버가 있다고 하자. 이 서버들에 부하를 균등하게 나누는 보편적인 방법은 아래 해시 함수를 사용하는 것이다.

serverIndex = hash(key) % N(서버 개수)

특정 key가 보관되어 있는 서버를 알아내기 위해 해시에 모듈러 연산 n을 진행하면 어느 서버의 인덱스인지 확인할 수 있다. 

하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다. 

예를 들면, 서버 하나가 장애를 일으켜 동작이 중단된다면 서버 풀의 크기(서버 개수 N)가 3으로 변경된다. 

키에 대한 해시값은 변하지 않지만 모듈러 연산을 적용한 서버 인덱스 값은 완전히 틀려진다.

## 안정 해시

안정 해시는 해시 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다.

k는 키의 개수이고, n은 슬롯(slot)의 개수이다.

### 기본 구현법의 문제

- 서버와 키를 균동 분포 해시 함수를 사용해 해시 링에 배치
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버

⇒ 서버 추가 삭제를 감안하면 파티션의 크기를 균등하게 유지하는 게 불가능하다. 

어떤 서버는 큰 해시 공간을 할당 받고, 어떤 서버는 큰 해시 공간을 할당 받는 상황이 가능하다는 것이다.

- 파티션: 인접한 서버 사이의 해시 공간이다.

### 해결법 : 가상 노드

가상 노드는 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다. 각 물리적 노드가 여러 가상 노드로 분활된다,.

가상노드를 통해 키 분포를 더 균등하게 할 수 있으며, 표준 편차가 작아져서 데이터가 고르게 분포된다. 그러나 가상 노드 데이터를 저장할 공간은 더 많이 필요하므로 시스템 요구사항에 맞도록 노드 개수를 적절히 조정해야 한다.

# Cassandra vnode

[[Cassandra] Cassandra vnode란?](https://devlog-wjdrbs96.tistory.com/445)